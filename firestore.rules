rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      // Allow all authenticated users to read any user document (needed for email search and collaboration)
      allow read: if request.auth != null;
      
      // Allow users to create/update their own document
      allow create, update: if request.auth != null && request.auth.uid == userId;
      
      // Folders subcollection
      match /folders/{folderId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Lists subcollection
      match /lists/{listId} {
        // Allow all authenticated users to read any list (needed for collaboration)
        allow read: if request.auth != null;
        
         // Allow owner write, or collaborator write when a share doc exists with editor/owner role
         allow write: if request.auth != null && (
           request.auth.uid == userId ||
           exists(/databases/$(database)/documents/shares/$(listId + '_' + request.auth.uid)) &&
           get(/databases/$(database)/documents/shares/$(listId + '_' + request.auth.uid)).data.role in ['editor', 'owner']
         );
      }
    }
    
    // Shares collection
    match /shares/{shareId} {
      // Owner can create shares
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerUserId;
      
      // Anyone can read shares (needed for querying shared lists)
      allow read: if request.auth != null;
      
      // Owner can update/delete
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.ownerUserId;
    }
  }
}
